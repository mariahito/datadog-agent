name: Deploy Infrastructure & Agent

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DD_API_KEY: ${{ secrets.DD_API_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      # ---------------------------------------------------------
      # STEP 1: INFRASTRUCTURE (Run inside /terraform folder)
      # ---------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3  # Upgraded to v3

      - name: Terraform Init & Apply
        id: terraform
        working-directory: ./terraform
        run: |
          terraform init
          # -no-color is CRITICAL here to stop inventory corruption
          terraform apply -auto-approve -input=false -no-color
          
          # Capture IPs cleanly using -no-color again
          DEV_IP=$(terraform output -raw -no-color dev_ip)
          TEST_IP=$(terraform output -raw -no-color test_ip)
          PROD_IP=$(terraform output -raw -no-color prod_ip)
          
          # Build the inventory file in the PARENT directory
          echo "[dev]" > ../inventory.ini
          echo "$DEV_IP env_tag=dev" >> ../inventory.ini
          
          echo "[test]" >> ../inventory.ini
          echo "$TEST_IP env_tag=test" >> ../inventory.ini
          
          echo "[prod]" >> ../inventory.ini
          echo "$PROD_IP env_tag=prod" >> ../inventory.ini
          
          # Debug: Print file content to logs so you can verify it
          cat ../inventory.ini

      # ---------------------------------------------------------
      # STEP 2: CONFIGURATION (Run inside /ansible folder)
      # ---------------------------------------------------------
      - name: Setup SSH Key
        run: |
          # The key is generated inside /terraform, we need to move/permission it
          mv terraform/ansible_key.pem .
          chmod 400 ansible_key.pem

      - name: Run Ansible Playbook
        working-directory: ./ansible
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          
          # Point to inventory in root (../inventory.ini) 
          # Point to key in root (../ansible_key.pem)
          ansible-playbook -i ../inventory.ini playbook.yml \
            --private-key ../ansible_key.pem

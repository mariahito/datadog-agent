---
- name: Deploy Kubernetes (MicroK8s) & Datadog via Helm
  hosts: all
  become: yes
  remote_user: ubuntu
  vars:
    datadog_api_key: "{{ lookup('env', 'DD_API_KEY') }}"
    datadog_site: "datadoghq.com"
    # Ensure lowercase for Kubernetes compatibility
    cluster_name_val: "{{ hostname_alias | lower }}"

  tasks:
    # -------------------------------------------------------
    # PHASE 0: PRE-FLIGHT CHECKS
    # -------------------------------------------------------
    - name: DEBUG - Verify Inventory Variables
      debug:
        msg: 
          - "---------------------------------------------------"
          - "TARGET HOST:    {{ inventory_hostname }}"
          - "HOSTNAME ALIAS: {{ hostname_alias }}"
          - "CLUSTER NAME:   {{ cluster_name_val }}"
          - "---------------------------------------------------"

    # -------------------------------------------------------
    # PHASE 1: BOOTSTRAP KUBERNETES (MicroK8s)
    # -------------------------------------------------------
    - name: Install MicroK8s (Lightweight Kubernetes)
      snap:
        name: microk8s
        classic: yes
        channel: 1.28/stable

    - name: Wait for MicroK8s to be Ready
      shell: microk8s status --wait-ready
      changed_when: false

    - name: Enable Helm and DNS addons
      shell: microk8s enable helm dns
      register: addons_result
      changed_when: "'already enabled' not in addons_result.stdout"

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0700'

    - name: Export Kubeconfig
      shell: microk8s config > /root/.kube/config

    # -------------------------------------------------------
    # PHASE 2: GENERATE DATADOG CONFIGURATION
    # -------------------------------------------------------
    - name: Create Datadog Values File (/tmp/datadog-values.yaml)
      copy:
        dest: /tmp/datadog-values.yaml
        content: |
          datadog:
            apiKey: "{{ datadog_api_key }}"
            site: "{{ datadog_site }}"
            clusterName: "{{ cluster_name_val }}"
            hostname: "{{ hostname_alias }}"
            kubelet:
              tlsVerify: false
            
            # --- FIX: PROCESS AGENT MUST BE HERE (INDENTED) ---
            processAgent:
              enabled: true
              processCollection: true
            # --------------------------------------------------

            # Global Environment Variables
            env:
              - name: DD_CLUSTER_NAME
                value: "{{ cluster_name_val }}"
              - name: DD_HOSTNAME
                value: "{{ hostname_alias }}"
              - name: DD_CLOUD_PROVIDER_METADATA
                value: "false"
              - name: DD_EC2_METADATA_ENABLED
                value: "false"
              
              # --- FORCE PROCESS COLLECTION ---
              - name: DD_PROCESS_CONFIG_PROCESS_COLLECTION_ENABLED
                value: "true"

            tags:
              - "env:{{ env_tag }}"
              - "deploy_method:helm"

          # Cluster Agent config stays at the root
          clusterAgent:
            enabled: true
            replicas: 1
            env:
              - name: DD_CLUSTER_NAME
                value: "{{ cluster_name_val }}"
          
          # Orchestrator stays at the root
          orchestratorExplorer:
            enabled: true
          
          agents:
            useHostNetwork: true

    # -------------------------------------------------------
    # PHASE 3: DEPLOY DATADOG
    # -------------------------------------------------------
    - name: Add Datadog Helm Repo
      kubernetes.core.helm_repository:
        name: datadog
        repo_url: https://helm.datadoghq.com
        binary_path: /snap/bin/microk8s.helm

    - name: Deploy Datadog Agent (From Values File)
      command: >
        /snap/bin/microk8s.helm upgrade --install datadog-agent datadog/datadog
        -f /tmp/datadog-values.yaml
        --namespace default
      environment:
        KUBECONFIG: /root/.kube/config

    # -------------------------------------------------------
    # PHASE 4: DEPLOY SIMULATED APP
    # -------------------------------------------------------
    - name: Deploy Simulated Customer App (NGINX)
      shell: |
        microk8s kubectl get deployment nginx-app || \
        microk8s kubectl create deployment nginx-app --image=nginx --replicas=2
      register: app_deploy
      changed_when: "'created' in app_deploy.stdout"

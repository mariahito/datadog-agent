---
- name: Deploy Kubernetes (MicroK8s) & Datadog via Helm
  hosts: all
  become: yes
  remote_user: ubuntu
  vars:
    datadog_api_key: "{{ lookup('env', 'DD_API_KEY') }}"
    datadog_site: "datadoghq.com"
    # Ensure lowercase for Kubernetes compatibility
    cluster_name_val: "{{ hostname_alias | lower }}"

  tasks:
    # -------------------------------------------------------
    # PHASE 1: BOOTSTRAP KUBERNETES (MicroK8s)
    # -------------------------------------------------------
    - name: Install MicroK8s (Lightweight Kubernetes)
      snap:
        name: microk8s
        classic: yes
        channel: 1.28/stable

    - name: Wait for MicroK8s to be Ready
      shell: microk8s status --wait-ready
      changed_when: false

    - name: Enable Helm and DNS addons
      shell: microk8s enable helm dns
      register: addons_result
      changed_when: "'already enabled' not in addons_result.stdout"

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0700'

    - name: Export Kubeconfig
      shell: microk8s config > /root/.kube/config

    # -------------------------------------------------------
    # PHASE 2: CLEANUP (The "Nuclear" Fix)
    # -------------------------------------------------------
    # This guarantees we don't merge with old, broken config.
    # We remove the agent entirely so the next step is a fresh install.
    - name: Uninstall existing Datadog Agent (Clean Slate)
      command: /snap/bin/microk8s.helm uninstall datadog-agent
      environment:
        KUBECONFIG: /root/.kube/config
      ignore_errors: yes # It's okay if it's not installed yet

    # -------------------------------------------------------
    # PHASE 3: DEPLOY DATADOG VIA HELM
    # -------------------------------------------------------
    - name: Add Datadog Helm Repo
      kubernetes.core.helm_repository:
        name: datadog
        repo_url: https://helm.datadoghq.com
        binary_path: /snap/bin/microk8s.helm

    - name: Deploy Datadog Agent (Helm Chart)
      kubernetes.core.helm:
        name: datadog-agent
        chart_ref: datadog/datadog
        release_namespace: default
        binary_path: /snap/bin/microk8s.helm
        kubeconfig: /root/.kube/config
        update_repo_cache: yes
        values:
          datadog:
            apiKey: "{{ datadog_api_key }}"
            site: "{{ datadog_site }}"
            
            # 1. Force Cluster Name (Must be lowercase)
            clusterName: "{{ cluster_name_val }}"
            
            # 2. Force Hostname (The "Golden" Setting)
            # This tells Helm explicitly to ignore AWS metadata
            hostname: "{{ hostname_alias }}"

            kubelet:
              tlsVerify: false

            # 3. Force Environment Variables (The Safety Net)
            env:
              - name: DD_CLUSTER_NAME
                value: "{{ cluster_name_val }}"
              - name: DD_HOSTNAME
                value: "{{ hostname_alias }}"

            tags:
              - "env:{{ env_tag }}"
              - "deploy_method:helm"

          # Enable features to make the demo look good
          processAgent:
            enabled: true
            processCollection: true
          
          # Ensure Orchestrator is enabled for the cluster view
          orchestratorExplorer:
            enabled: true

          agents:
            useHostNetwork: true

    # -------------------------------------------------------
    # PHASE 4: DEPLOY SIMULATED APP
    # -------------------------------------------------------
    - name: Deploy Simulated Customer App (NGINX)
      shell: |
        microk8s kubectl get deployment nginx-app || \
        microk8s kubectl create deployment nginx-app --image=nginx --replicas=2
      register: app_deploy
      changed_when: "'created' in app_deploy.stdout"

---
- name: Deploy Kubernetes (MicroK8s) & Datadog via Helm
  hosts: all
  become: yes
  remote_user: ubuntu
  vars:
    datadog_api_key: "{{ lookup('env', 'DD_API_KEY') }}"
    datadog_site: "datadoghq.com"
    # Ensure lowercase for Kubernetes compatibility
    cluster_name_val: "{{ hostname_alias | lower }}"

  tasks:
    # -------------------------------------------------------
    # PHASE 0: DEBUG & VERIFICATION
    # -------------------------------------------------------
    - name: DEBUG - Verify Hostname Variable
      debug:
        msg: "Deploying Agent with Hostname: {{ hostname_alias }} and Cluster: {{ cluster_name_val }}"

    # -------------------------------------------------------
    # PHASE 1: BOOTSTRAP KUBERNETES (MicroK8s)
    # -------------------------------------------------------
    - name: Install MicroK8s (Lightweight Kubernetes)
      snap:
        name: microk8s
        classic: yes
        channel: 1.28/stable

    - name: Wait for MicroK8s to be Ready
      shell: microk8s status --wait-ready
      changed_when: false

    - name: Enable Helm and DNS addons
      shell: microk8s enable helm dns
      register: addons_result
      changed_when: "'already enabled' not in addons_result.stdout"

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0700'

    - name: Export Kubeconfig
      shell: microk8s config > /root/.kube/config

    # -------------------------------------------------------
    # PHASE 2: SCORCHED EARTH (Force Delete)
    # -------------------------------------------------------
    - name: FORCE DELETE Datadog DaemonSet (Kill everything)
      shell: |
        /snap/bin/microk8s.kubectl delete daemonset datadog-agent --ignore-not-found=true
        /snap/bin/microk8s.helm uninstall datadog-agent || true
      ignore_errors: yes

    - name: Wait for pods to terminate
      shell: /snap/bin/microk8s.kubectl wait --for=delete pod -l app.kubernetes.io/name=datadog-agent --timeout=60s
      ignore_errors: yes

    # -------------------------------------------------------
    # PHASE 3: DEPLOY DATADOG VIA HELM
    # -------------------------------------------------------
    - name: Add Datadog Helm Repo
      kubernetes.core.helm_repository:
        name: datadog
        repo_url: https://helm.datadoghq.com
        binary_path: /snap/bin/microk8s.helm

    - name: Deploy Datadog Agent (Helm Chart)
      kubernetes.core.helm:
        name: datadog-agent
        chart_ref: datadog/datadog
        release_namespace: default
        binary_path: /snap/bin/microk8s.helm
        kubeconfig: /root/.kube/config
        update_repo_cache: yes
        values:
          datadog:
            apiKey: "{{ datadog_api_key }}"
            site: "{{ datadog_site }}"
            clusterName: "{{ cluster_name_val }}"
            
            # --- HOSTNAME CONFIGURATION ---
            hostname: "{{ hostname_alias }}"
            
            # --- KUBELET CONFIGURATION ---
            kubelet:
              tlsVerify: false

            # --- GLOBAL ENVIRONMENT VARIABLES ---
            # These apply to ALL containers (Core, Process, Trace)
            env:
              - name: DD_CLUSTER_NAME
                value: "{{ cluster_name_val }}"
              - name: DD_HOSTNAME
                value: "{{ hostname_alias }}"
              # DISABLE AWS METADATA (Forces Agent to use our hostname)
              - name: DD_CLOUD_PROVIDER_METADATA
                value: "false"
              - name: DD_EC2_METADATA_ENABLED
                value: "false"

            tags:
              - "env:{{ env_tag }}"
              - "deploy_method:helm"

          # --- CLUSTER AGENT CONFIGURATION ---
          clusterAgent:
            enabled: true
            replicas: 1
            # Pass the cluster name explicitly to the Cluster Agent too
            env:
              - name: DD_CLUSTER_NAME
                value: "{{ cluster_name_val }}"

          processAgent:
            enabled: true
            processCollection: true
          
          orchestratorExplorer:
            enabled: true

          agents:
            useHostNetwork: true

    # -------------------------------------------------------
    # PHASE 4: DEPLOY SIMULATED APP
    # -------------------------------------------------------
    - name: Deploy Simulated Customer App (NGINX)
      shell: |
        microk8s kubectl get deployment nginx-app || \
        microk8s kubectl create deployment nginx-app --image=nginx --replicas=2
      register: app_deploy
      changed_when: "'created' in app_deploy.stdout"

---
- name: Deploy Kubernetes (MicroK8s) & Datadog via Helm
  hosts: all
  become: yes
  remote_user: ubuntu
  vars:
    datadog_api_key: "{{ lookup('env', 'DD_API_KEY') }}"
    datadog_site: "datadoghq.com"
    # We use the hostname alias to label the K8s Node
    node_name: "{{ hostname_alias | lower }}"

  tasks:
    # -------------------------------------------------------
    # PHASE 1: BOOTSTRAP KUBERNETES (MicroK8s)
    # -------------------------------------------------------
    - name: Install MicroK8s (Lightweight Kubernetes)
      snap:
        name: microk8s
        classic: yes
        channel: 1.28/stable

    - name: Wait for MicroK8s to be Ready
      shell: microk8s status --wait-ready
      changed_when: false

    - name: Enable Helm and DNS addons
      shell: microk8s enable helm dns
      register: addons_result
      changed_when: "'already enabled' not in addons_result.stdout"

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0700'

    - name: Export Kubeconfig (so Helm works)
      shell: microk8s config > /root/.kube/config

    # -------------------------------------------------------
    # PHASE 2: DEPLOY DATADOG VIA HELM
    # -------------------------------------------------------
    - name: Add Datadog Helm Repo
      kubernetes.core.helm_repository:
        name: datadog
        repo_url: https://helm.datadoghq.com
        binary_path: /snap/bin/microk8s.helm

    - name: Deploy Datadog Agent (Helm Chart)
      kubernetes.core.helm:
        name: datadog-agent
        chart_ref: datadog/datadog
        release_namespace: default
        binary_path: /snap/bin/microk8s.helm
        kubeconfig: /root/.kube/config
        update_repo_cache: yes
        values:
          datadog:
            apiKey: "{{ datadog_api_key }}"
            site: "{{ datadog_site }}"
            # K8s Specific Configuration
            kubelet:
              tlsVerify: false
            tags:
              - "env:{{ env_tag }}"
              - "deploy_method:helm"
          # This forces the Datadog Hostname to match our AWS Alias
          # effectively naming the node inside Datadog
          agents:
            useHostNetwork: true
            config:
              hostname: "{{ hostname_alias }}"
